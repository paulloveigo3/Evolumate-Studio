<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>Evolumate Studio - Pro</title>
<script src="https://unpkg.com/coi-serviceworker/coi-serviceworker.min.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@ffmpeg/util@0.12.1/dist/umd/index.js"></script>

<style>
  /* === 內建 CSS (完全取代 Tailwind，解決 Vercel 報錯問題) === */
  :root {
    --bg-dark: #030712;
    --bg-panel: #111827;
    --border: #1f2937;
    --text-main: #e5e7eb;
    --text-muted: #9ca3af;
    --primary: #3b82f6;
    --primary-hover: #2563eb;
    --accent-green: #22c55e;
    --accent-red: #ef4444;
  }

  body { margin: 0; padding: 0; background-color: var(--bg-dark); color: var(--text-main); font-family: system-ui, -apple-system, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
  
  /* 滾動條 */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg-panel); }
  ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: #4b5563; }

  /* 頂部 Header */
  header { height: 56px; background: var(--bg-panel); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 24px; flex-shrink: 0; z-index: 20; }
  .header-left, .header-right { display: flex; align-items: center; gap: 16px; }
  .logo { font-weight: bold; letter-spacing: 1px; color: #d1d5db; display: flex; align-items: center; gap: 8px; font-size: 14px; }
  .logo span { color: var(--primary); }
  .logo-dot { width: 12px; height: 12px; border-radius: 50%; background: linear-gradient(to right, #3b82f6, #a855f7); box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
  
  /* 設定按鈕 */
  .settings-btn { width: 36px; height: 36px; border-radius: 50%; background: #1f2937; border: 1px solid #374151; color: #9ca3af; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s; }
  .settings-btn:hover { color: var(--primary); border-color: var(--primary); transform: rotate(90deg); background: #374151; }
  
  /* 狀態列 */
  .status-item { font-size: 12px; font-family: monospace; color: var(--text-muted); display: flex; align-items: center; gap: 8px; border-left: 1px solid #374151; padding-left: 16px; margin-left: 8px;}
  .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent-red); transition: background 0.5s; box-shadow: 0 0 8px rgba(239, 68, 68, 0.6); }
  .status-dot.ready { background: var(--accent-green); box-shadow: 0 0 8px rgba(34, 197, 94, 0.6); }
  .auth-status { font-size: 12px; color: var(--accent-green); display: flex; align-items: center; gap: 6px; }
  .hidden { display: none !important; }

  /* 主佈局 */
  .main-layout { display: grid; grid-template-columns: 320px 1fr; height: 100%; overflow: hidden; }
  .sidebar { background: var(--bg-panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; height: 100%; }
  .content { background: #000; position: relative; display: flex; flex-direction: column; height: 100%; }

  /* 側邊欄區塊 */
  .panel-section { padding: 20px; border-bottom: 1px solid var(--border); }
  .panel-title { font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
  .blue-text { color: #60a5fa; }
  .green-text { color: #4ade80; }

  /* 上傳區 */
  .dropzone { border: 2px dashed #374151; border-radius: 8px; height: 120px; background: rgba(31, 41, 55, 0.4); display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; position: relative; }
  .dropzone:hover { border-color: var(--primary); background: rgba(59, 130, 246, 0.1); }
  .dropzone input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
  .dropzone-icon { width: 32px; height: 32px; color: #6b7280; margin-bottom: 8px; }
  .dropzone-text { font-size: 11px; color: #9ca3af; font-weight: 500; }

  /* 控制項 */
  .control-group { margin-bottom: 16px; }
  .control-label { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; font-size: 11px; color: var(--text-muted); }
  
  input[type="color"] { width: 32px; height: 28px; padding: 0; border: 1px solid #4b5563; background: none; cursor: pointer; border-radius: 4px; }
  input[type="text"] { flex: 1; background: #1f2937; border: 1px solid #374151; color: white; padding: 4px 8px; border-radius: 4px; font-family: monospace; font-size: 12px; outline: none; }
  input[type="text"]:focus { border-color: var(--primary); }
  
  input[type="range"] { width: 100%; height: 4px; background: #374151; border-radius: 2px; appearance: none; cursor: pointer; display: block; }
  input[type="range"]::-webkit-slider-thumb { appearance: none; width: 14px; height: 14px; background: var(--primary); border-radius: 50%; transition: 0.2s; }
  input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.2); }
  
  input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; accent-color: var(--primary); }

  /* 按鈕 */
  .btn { width: 100%; padding: 10px; border-radius: 6px; font-weight: bold; font-size: 13px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; border: none; }
  .btn-primary { background: linear-gradient(to right, #2563eb, #3b82f6); color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
  .btn-primary:hover { filter: brightness(1.1); transform: translateY(-1px); }
  .btn-primary:active { transform: translateY(0); }
  .btn-preview { background: #1f2937; border: 1px solid #374151; color: #e5e7eb; margin-top: 12px; }
  .btn-preview:hover { background: #374151; border-color: #4b5563; }

  /* Radio Group */
  .radio-group { display: flex; gap: 10px; margin-bottom: 16px; }
  .radio-option { flex: 1; background: #1f2937; padding: 8px; border-radius: 4px; font-size: 11px; cursor: pointer; display: flex; gap: 6px; align-items: center; border: 1px solid #374151; color: #d1d5db; transition: 0.2s; }
  .radio-option:hover { border-color: var(--text-muted); }
  .radio-option:has(input:checked) { border-color: var(--accent-green); background: rgba(34, 197, 94, 0.1); }

  /* LOGS */
  .logs-container { height: 140px; background: #000; padding: 10px; display: flex; flex-direction: column; border-top: 1px solid var(--border); font-family: monospace; font-size: 10px; line-height: 1.5; }
  .logs-header { display: flex; justify-content: space-between; color: #6b7280; margin-bottom: 6px; font-size: 9px; font-weight: bold; }
  .logs-content { flex: 1; overflow-y: auto; color: #4ade80; }
  .log-err { color: #ef4444; }

  /* 右側內容 */
  .preview-section { flex: 2; display: flex; align-items: center; justify-content: center; background-image: linear-gradient(45deg, #1a1a1a 25%, transparent 25%), linear-gradient(-45deg, #1a1a1a 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #1a1a1a 75%), linear-gradient(-45deg, transparent 75%, #1a1a1a 75%); background-size: 20px 20px; background-color: #0f0f0f; border-bottom: 1px solid var(--border); position: relative; }
  canvas { max-width: 90%; max-height: 90%; box-shadow: 0 0 20px rgba(0,0,0,0.5); border: 1px solid #333; }
  .preview-label { position: absolute; top: 16px; left: 16px; font-size: 10px; background: #000; padding: 4px 8px; border: 1px solid #333; color: #666; border-radius: 4px; font-weight: bold; letter-spacing: 1px; }

  /* 時間軸 */
  .timeline-section { flex: 1; background: #0f1115; display: flex; flex-direction: column; overflow: hidden; min-height: 150px; }
  .timeline-header { padding: 8px 16px; font-size: 10px; color: #6b7280; border-bottom: 1px solid var(--border); background: var(--bg-panel); display: flex; justify-content: space-between; font-weight: bold; }
  .timeline-track { flex: 1; overflow-x: auto; overflow-y: hidden; white-space: nowrap; padding: 10px; display: flex; align-items: center; gap: 2px; }
  .timeline-frame { height: 100%; border-right: 1px solid #333; opacity: 0.8; transition: 0.2s; flex-shrink: 0; width: 160px; }
  .timeline-frame:hover { opacity: 1; border-color: #666; }

  /* Modal */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(4px); z-index: 50; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; }
  .modal-overlay.active { opacity: 1; pointer-events: auto; }
  .modal-box { background: var(--bg-panel); border: 1px solid #374151; padding: 30px; border-radius: 16px; width: 360px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); transform: scale(0.95); transition: 0.2s; text-align: center; }
  .modal-overlay.active .modal-box { transform: scale(1); }
  
  .close-modal { position: absolute; top: 12px; right: 12px; background: none; border: none; color: #6b7280; cursor: pointer; font-size: 20px; }
  .close-modal:hover { color: white; }

  /* 進度圈 */
  .progress-ring circle { transition: stroke-dashoffset 0.3s; transform: rotate(-90deg); transform-origin: 50% 50%; }
</style>
</head>
<body>

  <header>
    <div class="header-left">
      <button id="open-settings-btn" class="settings-btn" title="設定">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.572 1.065c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
      </button>
      <div style="height:24px; width:1px; background:#374151;"></div>
      <div class="logo">
        <div class="logo-dot"></div>
        EVOLUMATE <span>PRO</span>
      </div>
    </div>
    <div class="header-right">
      <div id="auth-indicator" class="auth-status hidden">
        <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/></svg>
        已登入 Google Drive
      </div>
      <div class="status-item">
        <span id="engine-dot" class="status-dot"></span>
        <span id="engine-status">Loading Engine...</span>
      </div>
    </div>
  </header>

  <div class="main-layout">
    <aside class="sidebar">
      <div class="panel-section">
        <span class="panel-title">1. 來源影片</span>
        <div class="dropzone">
          <input type="file" id="uploader" accept="video/*">
          <svg class="dropzone-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
          <span class="dropzone-text">點擊或拖曳上傳</span>
        </div>
        <video id="source-video" class="hidden" muted playsinline></video>
      </div>

      <div class="panel-section" style="flex:1; overflow-y:auto;">
        <span class="panel-title blue-text">2. 去背參數 <input type="checkbox" id="enable-chroma" checked></span>
        
        <div class="control-group">
          <div class="control-label">去背顏色</div>
          <div style="display:flex; gap:8px;">
            <input type="color" id="key-color" value="#00FF00">
            <input type="text" id="key-color-text" value="#00FF00">
          </div>
        </div>

        <div class="control-group">
          <div class="control-label"><span>相似度</span><span id="val-sim" class="blue-text">0.30</span></div>
          <input type="range" id="similarity" min="0.01" max="0.7" step="0.01" value="0.3">
        </div>

        <div class="control-group">
          <div class="control-label"><span>平滑度</span><span id="val-blend" class="blue-text">0.10</span></div>
          <input type="range" id="blend" min="0.0" max="0.5" step="0.01" value="0.1">
        </div>

        <button id="apply-preview-btn" class="btn btn-preview">刷新預覽</button>
      </div>

      <div class="panel-section">
        <span class="panel-title green-text">3. 輸出設定</span>
        <div class="radio-group">
          <label class="radio-option">
            <input type="radio" name="output-mode" value="merged" checked> 合併 (單檔)
          </label>
          <label class="radio-option">
            <input type="radio" name="output-mode" value="split"> 分離 (雙檔)
          </label>
        </div>
        <button id="process-btn" class="btn btn-primary">生成並上傳至 Drive</button>
      </div>

      <div class="logs-container">
         <div class="logs-header"><span>SYSTEM LOGS</span><span style="cursor:pointer;" onclick="document.getElementById('logs').innerHTML=''">CLEAR</span></div>
         <div id="logs" class="logs-content"></div>
      </div>
    </aside>

    <main class="content">
      <div class="preview-area">
        <canvas id="preview-canvas"></canvas>
        <div class="preview-label">LIVE PREVIEW</div>
      </div>
      <div class="timeline-section">
          <div class="timeline-header">
              <span>TIMELINE</span>
              <span>SCROLL: MOVE / CTRL+SCROLL: ZOOM</span>
          </div>
          <div id="timeline-track" class="timeline-track transparency-grid">
              <div id="timeline-empty" style="color:#666; font-size:12px; margin:auto;">等待載入...</div>
          </div>
      </div>
    </main>
  </div>

  <div id="settings-modal" class="modal-overlay">
    <div class="modal-box">
      <button id="close-settings" class="close-modal">&times;</button>
      <h3 style="color:white; font-size:18px; margin-bottom:24px; font-weight:bold;">設定</h3>
      
      <div style="background:#1f2937; padding:16px; border-radius:8px; border:1px solid #374151; margin-bottom:20px;">
        <p style="font-size:12px; color:#9ca3af; margin-bottom:12px;">連結 Google Drive 以啟用儲存功能</p>
        <button id="auth-btn" class="btn" style="background:white; color:#111;">連結 Google 帳戶</button>
      </div>

      <div style="text-align:left; font-size:12px; color:#6b7280; line-height:1.8;">
        <p>• 儲存位置: Drive > <b>TempForChar</b></p>
        <p>• 運算核心: Local Multi-Thread</p>
        <p>• 版本: 050 (Vercel Fix)</p>
      </div>
    </div>
  </div>

  <div id="progress-modal" class="modal-overlay">
    <div class="modal-box" style="padding-top:40px;">
      <div style="position:relative; width:100px; height:100px; margin:0 auto 20px;">
        <svg width="100" height="100" viewBox="0 0 100 100">
          <circle cx="50" cy="50" r="45" fill="none" stroke="#1f2937" stroke-width="8"></circle>
          <circle id="progress-ring" class="progress-ring" cx="50" cy="50" r="45" fill="none" stroke="#3b82f6" stroke-width="8" stroke-dasharray="282.7" stroke-dashoffset="282.7"></circle>
        </svg>
        <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold; font-size:20px;">
          <span id="progress-text">0%</span>
        </div>
      </div>
      <div id="progress-detail" style="color:#9ca3af; font-size:12px; font-family:monospace;">INITIALIZING...</div>
    </div>
  </div>

<script>
// ==========================================
// ★★★ CLIENT ID (已填入您的 ID) ★★★
// ==========================================
const CLIENT_ID = '109304005862-23ir7vpl8a48vjd0t0vqs0rsfbh4049m.apps.googleusercontent.com';
const SCOPES = 'https://www.googleapis.com/auth/drive.file';

// --- 全域變數 ---
let tokenClient, accessToken = null;
let ffmpeg = null, fetchFile = null;
let isEngineReady = false, currentFile = null;
let originalFrames = [];

// --- 日誌系統 ---
const log = (msg, type='info') => {
    const p = document.createElement('div');
    p.textContent = `> ${msg}`;
    if(type === 'error') p.className = 'log-err';
    document.getElementById('logs').appendChild(p);
    document.getElementById('logs').scrollTop = 9999;
    console.log(`[${type.toUpperCase()}] ${msg}`);
};

// --- 初始化 (Total Blob Proxy) ---
(async () => {
    try {
        log("初始化全雲端核心...");
        
        // Helper: 下載並轉 Blob
        const fetchBlob = async (url, type) => {
            const r = await fetch(url);
            if (!r.ok) throw new Error(`Download Failed: ${url}`);
            return URL.createObjectURL(new Blob([await r.arrayBuffer()], { type }));
        };

        const BASE = "https://unpkg.com";
        // 1. 下載主程式與工具
        const [ffmpegBlob, utilBlob] = await Promise.all([
            fetchBlob(`${BASE}/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.js`, 'text/javascript'),
            fetchBlob(`${BASE}/@ffmpeg/util@0.12.1/dist/umd/index.js`, 'text/javascript')
        ]);

        // 2. 動態注入
        await new Promise(resolve => {
            const s1 = document.createElement('script'); s1.src = utilBlob; document.head.appendChild(s1);
            s1.onload = () => {
                const s2 = document.createElement('script'); s2.src = ffmpegBlob; document.head.appendChild(s2);
                s2.onload = resolve;
            };
        });

        // 3. 下載核心 (Multi-Thread)
        const [coreBlob, wasmBlob, workerBlob] = await Promise.all([
            fetchBlob(`${BASE}/@ffmpeg/core-mt@0.12.6/dist/umd/ffmpeg-core.js`, 'text/javascript'),
            fetchBlob(`${BASE}/@ffmpeg/core-mt@0.12.6/dist/umd/ffmpeg-core.wasm`, 'application/wasm'),
            fetchBlob(`${BASE}/@ffmpeg/core-mt@0.12.6/dist/umd/ffmpeg-core.worker.js`, 'text/javascript')
        ]);

        // 4. 啟動 FFmpeg
        const { FFmpeg } = FFmpegWASM;
        const { fetchFile: ff } = FFmpegUtil;
        fetchFile = ff;
        ffmpeg = new FFmpeg();

        await ffmpeg.load({
            coreURL: coreBlob,
            wasmURL: wasmBlob,
            workerURL: workerBlob // 強制指定 Worker Blob，解決 Vercel SecurityError
        });

        isEngineReady = true;
        document.getElementById('engine-status').textContent = "Ready (MT)";
        document.getElementById('engine-dot').classList.add('ready');
        log("運算引擎就緒 (Multi-Thread)", 'success');

    } catch(e) {
        log(`引擎錯誤: ${e.message}`, 'error');
        document.getElementById('engine-status').textContent = "Error";
    }
})();

// --- UI 邏輯 ---
const videoEl = document.getElementById('source-video');
const canvasEl = document.getElementById('preview-canvas');
const ctx = canvasEl.getContext('2d');

document.getElementById('uploader').onchange = (e) => handleFile(e.target.files[0]);
// (Dropzone 省略，可自行加上)

function handleFile(file) {
    if(!file) return;
    currentFile = file;
    document.getElementById('timeline-empty').classList.add('hidden');
    videoEl.src = URL.createObjectURL(file);
    videoEl.load();
    log(`已載入: ${file.name}`);
    
    // 生成時間軸預覽
    videoEl.onloadeddata = async () => {
        updatePreview();
        const track = document.getElementById('timeline-track');
        track.innerHTML = ''; 
        const count = Math.min(Math.ceil(videoEl.duration/1), 20);
        for(let i=0; i<count; i++) {
            videoEl.currentTime = i * (videoEl.duration/count);
            await new Promise(r => videoEl.onseeked = r);
            const cvs = document.createElement('canvas');
            cvs.className = 'timeline-frame';
            cvs.width = 160; cvs.height = 90;
            cvs.getContext('2d').drawImage(videoEl, 0, 0, 160, 90);
            track.appendChild(cvs);
        }
    };
}

const updatePreview = () => {
    if(!currentFile) return;
    canvasEl.width = 480; canvasEl.height = 270;
    ctx.drawImage(videoEl, 0, 0, 480, 270);
    // 這裡為了效能，僅顯示原圖。若需去背預覽需加上 ImageData 處理 (同 039)
};

// 綁定輸入
['key-color', 'similarity', 'blend', 'enable-chroma'].forEach(id => {
    document.getElementById(id).addEventListener('input', updatePreview);
});
document.getElementById('key-color').addEventListener('input', (e) => document.getElementById('key-color-text').value = e.target.value.toUpperCase());

// --- Google Auth ---
function initAuth() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (resp) => {
            if (resp.error) throw resp;
            accessToken = resp.access_token;
            document.getElementById('auth-btn').innerText = "✓ 已連結";
            document.getElementById('auth-indicator').classList.remove('hidden');
            toggleSettings(false);
        },
    });
}
document.getElementById('auth-btn').onclick = () => { if(!accessToken) tokenClient.requestAccessToken(); };

// --- Drive Upload ---
async function findOrCreateFolder(name, parentId='root') {
    const q = `'${parentId}' in parents and name='${name}' and mimeType='application/vnd.google-apps.folder' and trashed=false`;
    const r = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}`, { headers: { Authorization: `Bearer ${accessToken}` } });
    const d = await r.json();
    if (d.files && d.files.length) return d.files[0].id;
    const c = await fetch('https://www.googleapis.com/drive/v3/files', { method: 'POST', headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ name, mimeType: 'application/vnd.google-apps.folder', parents: [parentId] }) });
    return (await c.json()).id;
}
async function uploadToDrive(folderId, filename, blob) {
    const metadata = { name: filename, parents: [folderId] };
    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
    form.append('file', blob);
    await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', { method: 'POST', headers: { Authorization: `Bearer ${accessToken}` }, body: form });
}

// --- Process ---
document.getElementById('process-btn').onclick = async () => {
    if(!accessToken) return toggleSettings(true);
    if(!isEngineReady || !currentFile) return alert("系統未就緒");

    const modal = document.getElementById('progress-modal');
    const setProgress = (p, t) => {
        const off = 282.7 - (p/100)*282.7;
        document.getElementById('progress-ring').style.strokeDashoffset = off;
        document.getElementById('progress-text').innerText = Math.round(p)+'%';
        if(t) document.getElementById('progress-detail').innerText = t;
    };

    modal.classList.add('active');
    setProgress(0, "初始化...");

    try {
        const rootId = await findOrCreateFolder("TempForChar");
        const ts = new Date().toISOString().replace(/[-:T.]/g, '').slice(0,14);
        const completeId = await findOrCreateFolder("Complete", rootId);

        setProgress(10, "載入影片...");
        await ffmpeg.writeFile('input.mp4', await fetchFile(currentFile));

        const hex = document.getElementById('key-color-text').value.replace('#','0x');
        const sim = document.getElementById('similarity').value;
        const blend = document.getElementById('blend').value;
        const doChroma = document.getElementById('enable-chroma').checked;
        const mode = document.querySelector('input[name="output-mode"]:checked').value;
        const filter = doChroma ? `format=rgba,chromakey=${hex}:${sim}:${blend}` : "null";

        setProgress(20, "影片轉碼中 (Multi-Thread)...");
        await ffmpeg.exec(['-i','input.mp4','-vf',filter,'-c:v','libvpx-vp9','-b:v','0','-crf','30','-pix_fmt','yuva420p','-threads','0','-preset','ultrafast','-an','output_v.webm']);

        setProgress(60, "上傳影片...");
        const vData = await ffmpeg.readFile('output_v.webm');
        const vBlob = new Blob([vData.buffer], {type:'video/webm'});

        if (mode === 'merged') {
            setProgress(70, "合併音訊...");
            await ffmpeg.exec(['-i','input.mp4','-vn','-acodec','libmp3lame','-q:a','2','output_a.mp3']);
            await ffmpeg.exec(['-i','output_v.webm','-i','output_a.mp3','-c','copy','final.webm']);
            const fData = await ffmpeg.readFile('final.webm');
            await uploadToDrive(completeId, `Evolumate_${ts}_Merged.webm`, new Blob([fData.buffer], {type:'video/webm'}));
        } else {
            await uploadToDrive(completeId, `Evolumate_${ts}_Video.webm`, vBlob);
            setProgress(80, "處理音訊...");
            await ffmpeg.exec(['-i','input.mp4','-vn','-acodec','libmp3lame','-q:a','2','output_a.mp3']);
            const aData = await ffmpeg.readFile('output_a.mp3');
            await uploadToDrive(completeId, `Evolumate_${ts}_Audio.mp3`, new Blob([aData.buffer], {type:'audio/mp3'}));
        }

        setProgress(100, "完成！");
        alert("成功！檔案已上傳至 Drive。");

    } catch(e) {
        console.error(e);
        alert("錯誤: " + e.message);
    } finally {
        modal.classList.remove('active');
        try { await ffmpeg.deleteFile('input.mp4'); await ffmpeg.deleteFile('output_v.webm'); await ffmpeg.deleteFile('output_a.mp3'); await ffmpeg.deleteFile('final.webm'); } catch(e){}
    }
};

// Modal Toggles
const settingsModal = document.getElementById('settings-modal');
const toggleSettings = (s) => settingsModal.classList.toggle('active', s);
document.getElementById('open-settings-btn').onclick = () => toggleSettings(true);
document.getElementById('close-settings').onclick = () => toggleSettings(false);
settingsModal.onclick = (e) => { if(e.target === settingsModal) toggleSettings(false); };

window.onload = initAuth;
</script>
</body>
</html>