<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>Evolumate Studio - Pro</title>
<script src="https://unpkg.com/coi-serviceworker/coi-serviceworker.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@ffmpeg/util@0.12.1/dist/umd/index.js"></script>
<style>
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: #111827; }
  ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
  .glass-panel { background: rgba(31, 41, 55, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(75, 85, 99, 0.4); }
  .progress-ring__circle { transition: stroke-dashoffset 0.35s; transform: rotate(-90deg); transform-origin: 50% 50%; }
  .settings-btn { transition: transform 0.3s ease; }
  .settings-btn:hover { transform: rotate(90deg); }
</style>
</head>
<body class="bg-gray-950 text-gray-200 h-screen w-screen overflow-hidden font-sans flex flex-col">

  <header class="h-14 border-b border-gray-800 flex items-center justify-between px-6 bg-gray-900 shrink-0 z-20">
    <div class="flex items-center gap-4">
      <button id="open-settings-btn" class="settings-btn w-9 h-9 rounded-full bg-gray-800 border border-gray-600 flex items-center justify-center hover:bg-gray-700 hover:border-blue-500 hover:text-blue-400 transition shadow-lg group">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
      </button>
      <div class="h-6 w-px bg-gray-700 mx-2"></div>
      <div class="flex items-center gap-2">
        <div class="w-3 h-3 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 shadow-lg shadow-blue-500/50"></div>
        <h1 class="text-sm font-bold tracking-widest text-gray-300">EVOLUMATE <span class="text-blue-500">PRO</span></h1>
      </div>
    </div>
    <div class="flex items-center gap-4">
        <div class="text-xs font-mono text-gray-500 flex items-center gap-2 border-r border-gray-700 pr-4">
            <span class="w-2 h-2 rounded-full bg-red-500 transition-colors duration-500 shadow-sm" id="engine-dot"></span>
            <span id="engine-status">載入引擎中...</span>
        </div>
        <div id="user-status-indicator" class="hidden flex items-center gap-2 text-xs text-green-400">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <span>已登入</span>
        </div>
    </div>
  </header>

  <div class="flex-1 grid grid-cols-12 gap-0 overflow-hidden">
    <aside class="col-span-4 bg-gray-900 border-r border-gray-800 flex flex-col z-10 shadow-xl overflow-y-auto">
      <div class="p-6 space-y-6">
        <div>
            <h2 class="text-xs font-bold text-gray-500 uppercase mb-2">1. 來源影片</h2>
            <div id="dropzone" class="border-2 border-dashed border-gray-700 rounded-xl bg-gray-800/50 hover:bg-gray-800 transition cursor-pointer h-32 flex flex-col items-center justify-center relative group">
                <input type="file" id="uploader" accept="video/*" class="absolute inset-0 opacity-0 cursor-pointer z-10" />
                <div class="text-center group-hover:scale-105 transition">
                    <svg class="w-8 h-8 text-gray-500 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                    <span class="text-xs text-gray-400">點擊或拖曳影片</span>
                </div>
            </div>
            <video id="source-video" class="hidden"></video>
        </div>

        <div class="space-y-4 pt-4 border-t border-gray-800">
            <h2 class="text-xs font-bold text-blue-400 uppercase">2. 去背參數</h2>
            <div class="flex items-center justify-between">
                <span class="text-xs text-gray-400">啟用去背</span>
                <input type="checkbox" id="enable-chroma" class="accent-blue-500 w-4 h-4">
            </div>
            <div class="space-y-2">
                <label class="text-xs text-gray-500">關鍵顏色</label>
                <div class="flex gap-2">
                    <input type="color" id="key-color" value="#00FF00" class="cursor-pointer h-8 w-10 p-0 border-0 bg-transparent">
                    <input type="text" id="key-color-text" value="#00FF00" class="bg-gray-800 border border-gray-700 rounded text-xs px-2 w-full text-white font-mono">
                </div>
            </div>
            <div>
                <div class="flex justify-between text-xs mb-1"><span class="text-gray-400">相似度</span><span id="val-sim" class="text-blue-400 font-mono">0.30</span></div>
                <input type="range" id="similarity" min="0.01" max="0.7" step="0.01" value="0.3" class="w-full accent-blue-500 h-1 bg-gray-700 rounded-lg cursor-pointer">
            </div>
            <div>
                <div class="flex justify-between text-xs mb-1"><span class="text-gray-400">平滑度</span><span id="val-blend" class="text-blue-400 font-mono">0.10</span></div>
                <input type="range" id="blend" min="0.0" max="0.5" step="0.01" value="0.1" class="w-full accent-blue-500 h-1 bg-gray-700 rounded-lg cursor-pointer">
            </div>
        </div>

        <div class="pt-4 border-t border-gray-800 space-y-4">
             <h2 class="text-xs font-bold text-green-400 uppercase">3. 輸出設定</h2>
             <div class="flex gap-4">
                 <label class="flex items-center gap-2 cursor-pointer bg-gray-800 px-3 py-2 rounded border border-gray-700 hover:border-green-500 transition">
                     <input type="radio" name="output-mode" value="merged" checked class="accent-green-500">
                     <span class="text-xs text-gray-300">合併 (單檔)</span>
                 </label>
                 <label class="flex items-center gap-2 cursor-pointer bg-gray-800 px-3 py-2 rounded border border-gray-700 hover:border-green-500 transition">
                     <input type="radio" name="output-mode" value="split" class="accent-green-500">
                     <span class="text-xs text-gray-300">分離 (雙檔)</span>
                 </label>
             </div>
             
             <button id="process-btn" class="w-full bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white py-3 rounded-lg font-bold text-sm shadow-lg shadow-blue-900/30 transition transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                生成並上傳至 Google Drive
             </button>
        </div>
      </div>
    </aside>

    <main class="col-span-8 bg-black flex items-center justify-center relative">
        <div class="text-gray-600 text-xs tracking-widest absolute top-4 left-4 border border-gray-800 px-2 py-1 rounded">LIVE PREVIEW</div>
        <canvas id="preview-canvas" class="max-w-full max-h-full border border-gray-800 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCI+PHBhdGggZD0iTTAgMGgxMHYxMEgwem0xMCAxMGgxMHYxMEgxMHoiIGZpbGw9IiMzMzMiIGZpbGwtb3BhY2l0eT0iMC4xIi8+PC9zdmc+')]"></canvas>
    </main>
  </div>

  <div id="settings-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center transition-opacity opacity-0 pointer-events-none">
      <div class="bg-gray-900 border border-gray-700 rounded-2xl w-full max-w-md mx-4 shadow-2xl transform scale-95 transition-transform duration-200" id="settings-content">
          <div class="flex justify-between items-center px-6 py-4 border-b border-gray-800">
              <h3 class="text-lg font-bold text-white flex items-center gap-2">工具設定 (Settings)</h3>
              <button id="close-settings-btn" class="text-gray-500 hover:text-white transition"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
          </div>
          <div class="p-6 space-y-6">
              <div class="bg-gray-800/50 rounded-lg p-4 border border-gray-700">
                  <h4 class="text-xs font-bold text-gray-400 uppercase mb-3">Google 帳戶連結</h4>
                  <p class="text-xs text-gray-500 mb-4">連結您的 Google Drive 以自動儲存生成結果。</p>
                  <button id="auth-btn" class="w-full flex items-center justify-center gap-2 bg-white text-gray-800 px-4 py-2.5 rounded font-bold hover:bg-gray-200 transition">
                      <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12.545,10.239v3.821h5.445c-0.712,2.315-2.647,3.972-5.445,3.972c-3.332,0-6.033-2.701-6.033-6.032s2.701-6.032,6.033-6.032c1.498,0,2.866,0.549,3.921,1.453l2.814-2.814C17.503,2.988,15.139,2,12.545,2C7.021,2,2.543,6.477,2.543,12s4.478,10,10.002,10c8.396,0,10.249-7.85,9.426-11.748L12.545,10.239z"/></svg>
                      <span>連結 Google 帳戶</span>
                  </button>
              </div>
              <div>
                  <h4 class="text-xs font-bold text-gray-400 uppercase mb-3">關於本工具</h4>
                  <ul class="space-y-2 text-xs text-gray-400">
                      <li>• 檔案將存入 Drive > TempForChar</li>
                      <li>• 支援多執行緒加速</li>
                  </ul>
              </div>
          </div>
      </div>
  </div>

  <div id="progress-modal" class="fixed inset-0 bg-black/90 backdrop-blur-md z-50 hidden flex items-center justify-center">
      <div class="bg-gray-900 border border-gray-700 rounded-2xl p-10 flex flex-col items-center gap-8 shadow-2xl max-w-sm w-full mx-4 relative overflow-hidden">
          <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-purple-500"></div>
          <div class="relative w-40 h-40">
              <svg class="w-full h-full" viewBox="0 0 100 100">
                  <circle class="text-gray-800 stroke-current" stroke-width="6" cx="50" cy="50" r="45" fill="transparent"></circle>
                  <circle id="progress-ring" class="text-blue-500 progress-ring__circle stroke-current" stroke-width="6" stroke-linecap="round" cx="50" cy="50" r="45" fill="transparent" stroke-dasharray="282.7" stroke-dashoffset="282.7"></circle>
              </svg>
              <div class="absolute inset-0 flex items-center justify-center flex-col">
                  <span id="progress-text" class="text-3xl font-bold text-white font-mono">0%</span>
                  <span id="progress-status" class="text-[10px] text-gray-400 mt-2 uppercase tracking-widest animate-pulse">Initializing</span>
              </div>
          </div>
          <div class="text-center w-full">
              <div id="progress-detail" class="text-sm text-gray-300 font-medium truncate">正在準備環境...</div>
          </div>
      </div>
  </div>

<script>
// ==========================================
// ★★★ 請替換成您的 CLIENT ID ★★★
// ==========================================
const CLIENT_ID = 'YOUR_GOOGLE_CLIENT_ID'; 
const SCOPES = 'https://www.googleapis.com/auth/drive.file';

// --- VARS ---
let tokenClient;
let accessToken = null;
let ffmpeg = null;
let fetchFile = null;
let isEngineReady = false;
let currentFile = null;

// --- AUTH ---
function initAuth() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (resp) => {
            if (resp.error) throw resp;
            accessToken = resp.access_token;
            updateAuthUI(true);
            toggleSettings(false);
        },
    });
}
document.getElementById('auth-btn').onclick = () => {
    if (accessToken) { accessToken = null; updateAuthUI(false); } 
    else tokenClient.requestAccessToken();
};
function updateAuthUI(isLoggedIn) {
    const btn = document.getElementById('auth-btn');
    const indicator = document.getElementById('user-status-indicator');
    if (isLoggedIn) {
        btn.innerHTML = `<span class="text-green-500 font-bold">✓ 已連結</span>`;
        indicator.classList.remove('hidden');
    } else {
        btn.innerHTML = `<span>連結 Google 帳戶</span>`;
        indicator.classList.add('hidden');
    }
}

// --- FFMPEG INIT (BLOB PROXY FIX) ---
(async () => {
    try {
        console.log("Loading Engine with Blob Proxy...");
        const { FFmpeg } = FFmpegWASM;
        const { fetchFile: ff } = FFmpegUtil;
        fetchFile = ff;
        ffmpeg = new FFmpeg();

        // 1. 下載 Worker 並轉為 Blob，繞過 CORS/COEP 限制
        const baseURL = 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.6/dist/umd';
        const workerBlob = await fetch(`${baseURL}/ffmpeg-core.worker.js`).then(r => r.blob());
        const workerURL = URL.createObjectURL(workerBlob);

        // 2. 載入 (使用 Blob URL 作為 Worker)
        await ffmpeg.load({
            coreURL: `${baseURL}/ffmpeg-core.js`,
            wasmURL: `${baseURL}/ffmpeg-core.wasm`,
            workerURL: workerURL // 關鍵修正
        });

        isEngineReady = true;
        document.getElementById('engine-status').textContent = "引擎就緒 (高效能)";
        document.getElementById('engine-dot').classList.replace('bg-red-500', 'bg-green-500');
    } catch(e) {
        console.error(e);
        alert("引擎載入失敗: " + e.message);
    }
})();

// --- DRIVE & PROCESS LOGIC ---
// (Drive API Helpers remain the same as previous)
async function findOrCreateFolder(name, parentId='root') {
    const q = `'${parentId}' in parents and name='${name}' and mimeType='application/vnd.google-apps.folder' and trashed=false`;
    const r = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}`, { headers: { Authorization: `Bearer ${accessToken}` } });
    const d = await r.json();
    if (d.files.length) return d.files[0].id;
    const c = await fetch('https://www.googleapis.com/drive/v3/files', { method: 'POST', headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ name, mimeType: 'application/vnd.google-apps.folder', parents: [parentId] }) });
    return (await c.json()).id;
}
async function uploadToDrive(folderId, filename, blob) {
    const meta = { name: filename, parents: [folderId] };
    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(meta)], { type: 'application/json' }));
    form.append('file', blob);
    await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', { method: 'POST', headers: { Authorization: `Bearer ${accessToken}` }, body: form });
}

// UI Logic
const videoEl = document.getElementById('source-video');
const canvasEl = document.getElementById('preview-canvas');
const ctx = canvasEl.getContext('2d');
document.getElementById('uploader').onchange = (e) => {
    const f = e.target.files[0];
    if(!f) return;
    currentFile = f;
    videoEl.src = URL.createObjectURL(f);
    videoEl.load();
    videoEl.onloadeddata = () => ctx.drawImage(videoEl, 0, 0, 480, 270);
};

// Modals
const toggleSettings = (s) => {
    const m = document.getElementById('settings-modal');
    const c = document.getElementById('settings-content');
    if(s) { m.classList.remove('hidden'); setTimeout(() => { m.classList.remove('opacity-0','pointer-events-none'); c.classList.remove('scale-95'); }, 10); }
    else { m.classList.add('opacity-0','pointer-events-none'); c.classList.add('scale-95'); setTimeout(() => m.classList.add('hidden'), 200); }
};
document.getElementById('open-settings-btn').onclick = () => toggleSettings(true);
document.getElementById('close-settings-btn').onclick = () => toggleSettings(false);

const setProgress = (p, t, s) => {
    const off = 282.7 - (p/100)*282.7;
    document.getElementById('progress-ring').style.strokeDashoffset = off;
    document.getElementById('progress-text').innerText = Math.round(p)+'%';
    if(t) document.getElementById('progress-detail').innerText = t;
    if(s) document.getElementById('progress-status').innerText = s;
};

// Main Process
document.getElementById('process-btn').onclick = async () => {
    if(!accessToken) return toggleSettings(true) || alert("請先登入");
    if(!isEngineReady || !currentFile) return alert("系統未就緒");
    
    document.getElementById('progress-modal').classList.remove('hidden');
    setProgress(0, "準備中...", "INIT");

    try {
        const rootId = await findOrCreateFolder("TempForChar");
        const ts = new Date().toISOString().replace(/[-:T.]/g, '').slice(0,14);
        const completeId = await findOrCreateFolder("Complete", rootId);

        setProgress(10, "載入影片...", "LOADING");
        await ffmpeg.writeFile('input.mp4', await fetchFile(currentFile));

        const hex = document.getElementById('key-color-text').value.replace('#','0x');
        const sim = document.getElementById('similarity').value;
        const blend = document.getElementById('blend').value;
        const doChroma = document.getElementById('enable-chroma').checked;
        const mode = document.querySelector('input[name="output-mode"]:checked').value;
        const filter = doChroma ? `format=rgba,chromakey=${hex}:${sim}:${blend}` : "null";

        setProgress(20, "轉碼中 (Multi-Thread)...", "ENCODING");
        await ffmpeg.exec(['-i','input.mp4','-vf',filter,'-c:v','libvpx-vp9','-b:v','0','-crf','30','-pix_fmt','yuva420p','-threads','0','-preset','ultrafast','-an','out_v.webm']);

        setProgress(70, "上傳影片...", "UPLOADING");
        const vData = await ffmpeg.readFile('out_v.webm');
        if(mode === 'split') {
            await uploadToDrive(completeId, `Evolumate_${ts}_Video.webm`, new Blob([vData.buffer], {type:'video/webm'}));
            setProgress(85, "處理音訊...", "AUDIO");
            await ffmpeg.exec(['-i','input.mp4','-vn','-acodec','libmp3lame','-q:a','2','out_a.mp3']);
            const aData = await ffmpeg.readFile('out_a.mp3');
            await uploadToDrive(completeId, `Evolumate_${ts}_Audio.mp3`, new Blob([aData.buffer], {type:'audio/mp3'}));
        } else {
            setProgress(80, "合併音訊...", "MERGING");
            await ffmpeg.exec(['-i','input.mp4','-vn','-acodec','libmp3lame','-q:a','2','out_a.mp3']);
            await ffmpeg.exec(['-i','out_v.webm','-i','out_a.mp3','-c','copy','final.webm']);
            const fData = await ffmpeg.readFile('final.webm');
            await uploadToDrive(completeId, `Evolumate_${ts}_Merged.webm`, new Blob([fData.buffer], {type:'video/webm'}));
        }

        setProgress(100, "完成！", "DONE");
        alert("成功！檔案已上傳至 Drive。");
    } catch(e) {
        console.error(e);
        alert("錯誤: " + e.message);
    } finally {
        document.getElementById('progress-modal').classList.add('hidden');
        try { await ffmpeg.deleteFile('input.mp4'); await ffmpeg.deleteFile('out_v.webm'); } catch(e){}
    }
};

window.onload = initAuth;
</script>
</body>
</html>