<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>Evolumate Studio - Pro</title>
<script src="https://unpkg.com/coi-serviceworker/coi-serviceworker.min.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
  /* === 內建 CSS (確保 UI 穩定) === */
  :root { --bg-dark: #030712; --bg-panel: #111827; --border: #1f2937; --text-main: #e5e7eb; --text-muted: #9ca3af; --primary: #3b82f6; --accent: #22c55e; }
  body { background-color: var(--bg-dark); color: var(--text-main); font-family: system-ui, -apple-system, sans-serif; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg-panel); }
  ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }

  header { height: 56px; background: var(--bg-panel); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 24px; flex-shrink: 0; z-index: 20; }
  .logo { font-weight: bold; letter-spacing: 1px; color: #d1d5db; display: flex; align-items: center; gap: 8px; font-size: 14px; }
  .logo span { color: var(--primary); }
  .status-bar { display: flex; align-items: center; gap: 16px; font-size: 12px; font-family: monospace; color: var(--text-muted); }
  
  .settings-btn { width: 32px; height: 32px; border-radius: 50%; background: #1f2937; border: 1px solid #374151; color: #9ca3af; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; }
  .settings-btn:hover { color: var(--primary); border-color: var(--primary); transform: rotate(90deg); }

  .main-layout { display: grid; grid-template-columns: 320px 1fr; height: 100%; overflow: hidden; }
  .sidebar { background: var(--bg-panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; }
  .content { background: #000; position: relative; display: flex; flex-direction: column; }

  .panel-section { padding: 20px; border-bottom: 1px solid var(--border); }
  .panel-title { font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; display: block; }
  .blue-title { color: #60a5fa; }
  
  .dropzone { border: 2px dashed #374151; border-radius: 8px; height: 100px; background: rgba(31, 41, 55, 0.4); display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; position: relative; }
  .dropzone:hover { border-color: var(--primary); background: rgba(59, 130, 246, 0.1); }
  .dropzone input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
  
  .control-group { margin-bottom: 16px; }
  .control-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; font-size: 11px; color: var(--text-muted); }
  input[type="range"] { width: 100%; height: 4px; background: #374151; border-radius: 2px; appearance: none; cursor: pointer; }
  input[type="range"]::-webkit-slider-thumb { appearance: none; width: 14px; height: 14px; background: var(--primary); border-radius: 50%; }
  input[type="text"] { background: #1f2937; border: 1px solid #374151; color: white; padding: 4px 8px; border-radius: 4px; font-family: monospace; font-size: 12px; width: 100%; box-sizing: border-box; }
  
  .btn-primary { width: 100%; background: linear-gradient(to right, #2563eb, #3b82f6); color: white; border: none; padding: 12px; border-radius: 6px; font-weight: bold; font-size: 13px; cursor: pointer; transition: 0.2s; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
  .btn-primary:hover { filter: brightness(1.1); transform: translateY(-1px); }
  .btn-primary:disabled { filter: grayscale(1); opacity: 0.5; cursor: not-allowed; }

  .preview-area { flex: 2; display: flex; align-items: center; justify-content: center; background-image: linear-gradient(45deg, #1a1a1a 25%, transparent 25%), linear-gradient(-45deg, #1a1a1a 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #1a1a1a 75%), linear-gradient(-45deg, transparent 75%, #1a1a1a 75%); background-size: 20px 20px; background-color: #0f0f0f; border-bottom: 1px solid var(--border); }
  canvas { max-width: 90%; max-height: 90%; box-shadow: 0 0 20px rgba(0,0,0,0.5); border: 1px solid #333; }

  .timeline-area { flex: 1; background: #0f1115; display: flex; flex-direction: column; overflow: hidden; min-height: 150px; }
  .timeline-header { padding: 8px 16px; font-size: 10px; color: #6b7280; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; background: var(--bg-panel); }
  .timeline-track { flex: 1; overflow-x: auto; overflow-y: hidden; white-space: nowrap; padding: 10px; display: flex; align-items: center; gap: 2px; }
  .timeline-frame { height: 100%; border-right: 1px solid #333; opacity: 0.8; transition: width 0.1s, opacity 0.2s; flex-shrink: 0; }
  .timeline-frame:hover { opacity: 1; border-color: #666; }

  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); z-index: 50; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; }
  .modal-overlay.active { opacity: 1; pointer-events: auto; }
  .modal-box { background: #111827; border: 1px solid #374151; padding: 24px; border-radius: 12px; width: 360px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5); text-align: center; transform: scale(0.95); transition: 0.2s; }
  .modal-overlay.active .modal-box { transform: scale(1); }
  .progress-ring circle { transition: stroke-dashoffset 0.3s; transform: rotate(-90deg); transform-origin: 50% 50%; }
  .hidden { display: none; }
</style>
</head>
<body>

  <header>
    <div style="display:flex; align-items:center; gap:16px;">
      <button id="open-settings-btn" class="settings-btn" title="設定">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
      </button>
      <div class="logo">EVOLUMATE <span>PRO</span></div>
    </div>
    <div class="status-bar">
      <div id="auth-indicator" class="hidden" style="color:#4ade80;">● 已登入</div>
      <div style="display:flex; align-items:center; gap:6px;">
        <span id="engine-dot" style="width:8px; height:8px; border-radius:50%; background:#ef4444; transition:0.5s;"></span>
        <span id="engine-status">Loading Engine...</span>
      </div>
    </div>
  </header>

  <div class="main-layout">
    <aside class="sidebar">
      <div class="panel-section">
        <span class="panel-title">1. 來源影片</span>
        <div class="dropzone">
          <input type="file" id="uploader" accept="video/*">
          <svg width="24" height="24" fill="none" stroke="#6b7280" stroke-width="2" viewBox="0 0 24 24"><path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
          <span style="font-size:10px; color:#6b7280; margin-top:8px;">點擊或拖曳上傳</span>
        </div>
        <video id="source-video" class="hidden"></video>
      </div>

      <div class="panel-section" style="flex:1; overflow-y:auto;">
        <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
          <span class="panel-title blue-title">2. 去背參數</span>
          <input type="checkbox" id="enable-chroma" checked style="cursor:pointer;">
        </div>
        <div class="control-group">
          <div class="control-row">去背顏色 (Key Color)</div>
          <div style="display:flex; gap:8px;">
            <input type="color" id="key-color" value="#00FF00" style="width:32px; height:24px; padding:0; border:none; background:none;">
            <input type="text" id="key-color-text" value="#00FF00">
          </div>
        </div>
        <div class="control-group">
          <div class="control-row"><span>相似度</span><span id="val-sim" style="color:#60a5fa;">0.30</span></div>
          <input type="range" id="similarity" min="0.01" max="0.7" step="0.01" value="0.3">
        </div>
        <div class="control-group">
          <div class="control-row"><span>平滑度</span><span id="val-blend" style="color:#60a5fa;">0.10</span></div>
          <input type="range" id="blend" min="0.0" max="0.5" step="0.01" value="0.1">
        </div>
      </div>

      <div class="panel-section">
        <span class="panel-title" style="color:#4ade80;">3. 輸出設定</span>
        <div style="display:flex; gap:10px; margin-bottom:16px;">
          <label style="flex:1; background:#1f2937; padding:8px; border-radius:4px; font-size:11px; cursor:pointer; display:flex; gap:4px; align-items:center; border:1px solid #374151;">
            <input type="radio" name="output-mode" value="merged" checked> 合併
          </label>
          <label style="flex:1; background:#1f2937; padding:8px; border-radius:4px; font-size:11px; cursor:pointer; display:flex; gap:4px; align-items:center; border:1px solid #374151;">
            <input type="radio" name="output-mode" value="split"> 分離
          </label>
        </div>
        <button id="process-btn" class="btn-primary">生成並上傳至 Drive</button>
      </div>
    </aside>

    <main class="content">
      <div class="preview-area">
        <canvas id="preview-canvas"></canvas>
        <div style="position:absolute; top:16px; left:16px; font-size:10px; background:#000; padding:4px 8px; border:1px solid #333; color:#666; border-radius:4px;">LIVE PREVIEW</div>
      </div>
      <div class="timeline-area">
          <div class="timeline-header">
              <span>TIMELINE</span>
              <span>SCROLL: MOVE / CTRL+SCROLL: ZOOM</span>
          </div>
          <div id="timeline-track" class="timeline-track transparency-grid">
              <div id="timeline-empty" style="width:100%; text-align:center; color:#4b5563; font-size:12px;">等待載入...</div>
          </div>
      </div>
    </main>
  </div>

  <div id="settings-modal" class="modal-overlay">
    <div class="modal-box">
      <h3 style="color:white; margin-bottom:20px; font-size:16px;">設定</h3>
      <div style="background:#1f2937; padding:16px; border-radius:8px; border:1px solid #374151; margin-bottom:20px;">
        <p style="font-size:12px; color:#9ca3af; margin-bottom:12px;">請連結 Google Drive 以啟用儲存功能。</p>
        <button id="auth-btn" style="width:100%; background:white; color:#111; border:none; padding:8px; border-radius:4px; font-weight:bold; cursor:pointer;">
          連結 Google 帳戶
        </button>
      </div>
      <button id="close-settings" style="margin-top:20px; background:none; border:none; color:#6b7280; cursor:pointer; font-size:12px;">關閉</button>
    </div>
  </div>

  <div id="progress-modal" class="modal-overlay">
    <div class="modal-box" style="width:280px; padding:30px;">
      <div style="position:relative; width:100px; height:100px; margin:0 auto 20px;">
        <svg width="100" height="100" viewBox="0 0 100 100">
          <circle cx="50" cy="50" r="45" fill="none" stroke="#1f2937" stroke-width="8"></circle>
          <circle id="progress-ring" class="progress-ring" cx="50" cy="50" r="45" fill="none" stroke="#3b82f6" stroke-width="8" stroke-dasharray="282.7" stroke-dashoffset="282.7"></circle>
        </svg>
        <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold; font-size:20px;">
          <span id="progress-text">0%</span>
        </div>
      </div>
      <div id="progress-detail" style="color:#9ca3af; font-size:12px;">初始化...</div>
    </div>
  </div>

<script>
// ==========================================
// ★★★ 請替換成您的 CLIENT ID ★★★
// ==========================================
const CLIENT_ID = 'YOUR_GOOGLE_CLIENT_ID';
const SCOPES = 'https://www.googleapis.com/auth/drive.file';

// --- 全域變數 ---
let tokenClient;
let accessToken = null;
let ffmpeg = null;
let fetchFile = null;
let isEngineReady = false;
let currentFile = null;

// --- 介面邏輯 ---
const videoEl = document.getElementById('source-video');
const canvasEl = document.getElementById('preview-canvas');
const ctx = canvasEl.getContext('2d');

document.getElementById('uploader').onchange = (e) => {
    const f = e.target.files[0];
    if(!f) return;
    currentFile = f;
    videoEl.src = URL.createObjectURL(f);
    videoEl.load();
    videoEl.onloadeddata = () => { updatePreview(); generateTimeline(); };
};

const updatePreview = () => {
    if(!currentFile) return;
    canvasEl.width = 480; canvasEl.height = 270;
    ctx.drawImage(videoEl, 0, 0, 480, 270);
};

['key-color', 'similarity', 'blend', 'enable-chroma'].forEach(id => {
    document.getElementById(id).addEventListener('input', updatePreview);
});
document.getElementById('key-color').addEventListener('input', (e) => document.getElementById('key-color-text').value = e.target.value.toUpperCase());

// --- 時間軸邏輯 ---
let zoomLevel = 1;
const timelineTrack = document.getElementById('timeline-track');
async function generateTimeline() {
    timelineTrack.innerHTML = ''; 
    const duration = videoEl.duration;
    const count = Math.min(Math.ceil(duration / 1), 20); 
    for(let i=0; i<count; i++) {
        const time = i * (duration / count);
        videoEl.currentTime = time;
        await new Promise(r => videoEl.onseeked = r);
        const cvs = document.createElement('canvas');
        cvs.width = 160; cvs.height = 90;
        cvs.className = 'timeline-frame';
        cvs.style.cssText = 'height:100%; border-right:1px solid #333; flex-shrink:0; width:160px;';
        const tCtx = cvs.getContext('2d');
        tCtx.drawImage(videoEl, 0, 0, 160, 90);
        timelineTrack.appendChild(cvs);
    }
}
timelineTrack.addEventListener('wheel', (e) => {
    e.preventDefault();
    if (e.ctrlKey) {
        const delta = Math.sign(e.deltaY) * -0.1;
        zoomLevel = Math.min(Math.max(0.5, zoomLevel + delta), 3);
        document.querySelectorAll('.timeline-frame').forEach(f => f.style.width = `${160 * zoomLevel}px`);
    } else {
        timelineTrack.scrollLeft += e.deltaY;
    }
});

// --- Modal 控制 ---
const settingsModal = document.getElementById('settings-modal');
const progressModal = document.getElementById('progress-modal');
const toggleSettings = (s) => settingsModal.classList.toggle('active', s);
document.getElementById('open-settings-btn').onclick = () => toggleSettings(true);
document.getElementById('close-settings').onclick = () => toggleSettings(false);
settingsModal.onclick = (e) => { if(e.target === settingsModal) toggleSettings(false); };

const setProgress = (p, t) => {
    const off = 282.7 - (p/100)*282.7;
    document.getElementById('progress-ring').style.strokeDashoffset = off;
    document.getElementById('progress-text').innerText = Math.round(p)+'%';
    if(t) document.getElementById('progress-detail').innerText = t;
};

// --- Auth ---
function initAuth() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (resp) => {
            if (resp.error) throw resp;
            accessToken = resp.access_token;
            document.getElementById('auth-btn').innerText = "✓ 已連結";
            document.getElementById('auth-indicator').classList.remove('hidden');
            settingsModal.classList.remove('active');
        },
    });
}
document.getElementById('auth-btn').onclick = () => { if(!accessToken) tokenClient.requestAccessToken(); };

// --- 關鍵修正：全自動 Blob 代理 (Total Blob Proxy) ---
// 這段代碼會自動把所有需要的 JS/WASM 抓下來變成 Blob，騙過瀏覽器
(async () => {
    try {
        console.log("Initializing Total Blob Proxy...");
        
        // 1. 定義所有需要的檔案 (多執行緒版)
        const BASE = "https://unpkg.com";
        // FFmpeg 主程式
        const FFMPEG_URL = `${BASE}/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.js`;
        const UTIL_URL = `${BASE}/@ffmpeg/util@0.12.1/dist/umd/index.js`;
        // 核心 (Core-MT)
        const CORE_JS = `${BASE}/@ffmpeg/core-mt@0.12.6/dist/umd/ffmpeg-core.js`;
        const CORE_WASM = `${BASE}/@ffmpeg/core-mt@0.12.6/dist/umd/ffmpeg-core.wasm`;
        const CORE_WORKER = `${BASE}/@ffmpeg/core-mt@0.12.6/dist/umd/ffmpeg-core.worker.js`;

        // 2. 通用 Fetcher
        const fetchBlob = async (url, type) => {
            const r = await fetch(url);
            if (!r.ok) throw new Error(`Download Failed: ${url}`);
            return URL.createObjectURL(new Blob([await r.arrayBuffer()], { type }));
        };

        // 3. 下載並注入主程式 (FFmpeg + Util)
        const [ffmpegBlob, utilBlob] = await Promise.all([
            fetchBlob(FFMPEG_URL, 'text/javascript'),
            fetchBlob(UTIL_URL, 'text/javascript')
        ]);

        // 動態載入 Script
        await new Promise(resolve => {
            const s1 = document.createElement('script'); s1.src = utilBlob; document.head.appendChild(s1);
            s1.onload = () => {
                const s2 = document.createElement('script'); s2.src = ffmpegBlob; document.head.appendChild(s2);
                s2.onload = resolve;
            };
        });

        // 4. 下載核心檔案
        const [coreBlob, wasmBlob, workerBlob] = await Promise.all([
            fetchBlob(CORE_JS, 'text/javascript'),
            fetchBlob(CORE_WASM, 'application/wasm'),
            fetchBlob(CORE_WORKER, 'text/javascript')
        ]);

        // 5. 初始化 FFmpeg 實例
        const { FFmpeg } = FFmpegWASM;
        const { fetchFile: ff } = FFmpegUtil;
        fetchFile = ff;
        ffmpeg = new FFmpeg();

        // 6. 載入 (使用 Blob URL)
        await ffmpeg.load({
            coreURL: coreBlob,
            wasmURL: wasmBlob,
            workerURL: workerBlob // 明確指定 Worker Blob，解決 404 & SecurityError
        });

        isEngineReady = true;
        document.getElementById('engine-status').textContent = "Ready (MT)";
        document.getElementById('engine-dot').style.background = "#22c55e";
        console.log("Engine Loaded Successfully!");

    } catch(e) {
        console.error(e);
        document.getElementById('engine-status').textContent = "Error";
        alert("引擎載入失敗，請檢查網路連線。\n" + e.message);
    }
})();

// --- Drive Helpers ---
async function findOrCreateFolder(name, parentId='root') {
    const q = `'${parentId}' in parents and name='${name}' and mimeType='application/vnd.google-apps.folder' and trashed=false`;
    const r = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}`, { headers: { Authorization: `Bearer ${accessToken}` } });
    const d = await r.json();
    if (d.files && d.files.length) return d.files[0].id;
    const c = await fetch('https://www.googleapis.com/drive/v3/files', { method: 'POST', headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ name, mimeType: 'application/vnd.google-apps.folder', parents: [parentId] }) });
    return (await c.json()).id;
}

async function uploadToDrive(folderId, filename, blob) {
    const metadata = { name: filename, parents: [folderId] };
    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
    form.append('file', blob);
    await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', { method: 'POST', headers: { Authorization: `Bearer ${accessToken}` }, body: form });
}

// --- Process ---
document.getElementById('process-btn').onclick = async () => {
    if(!accessToken) return settingsModal.classList.add('active');
    if(!isEngineReady || !currentFile) return alert("系統未就緒");

    progressModal.classList.add('active');
    setProgress(0, "初始化工作區...");

    try {
        const rootId = await findOrCreateFolder("TempForChar");
        const ts = new Date().toISOString().replace(/[-:T.]/g, '').slice(0,14);
        const completeId = await findOrCreateFolder("Complete", rootId);

        setProgress(10, "載入影片...");
        await ffmpeg.writeFile('input.mp4', await fetchFile(currentFile));

        const hex = document.getElementById('key-color-text').value.replace('#','0x');
        const sim = document.getElementById('similarity').value;
        const blend = document.getElementById('blend').value;
        const doChroma = document.getElementById('enable-chroma').checked;
        const mode = document.querySelector('input[name="output-mode"]:checked').value;
        const filter = doChroma ? `format=rgba,chromakey=${hex}:${sim}:${blend}` : "null";

        setProgress(20, "影片轉碼中 (Multi-Thread)...");
        await ffmpeg.exec(['-i','input.mp4','-vf',filter,'-c:v','libvpx-vp9','-b:v','0','-crf','30','-pix_fmt','yuva420p','-threads','0','-preset','ultrafast','-an','output_v.webm']);

        setProgress(60, "上傳影片...");
        const vData = await ffmpeg.readFile('output_v.webm');
        const vBlob = new Blob([vData.buffer], {type:'video/webm'});

        if (mode === 'merged') {
            setProgress(70, "合併音訊...");
            await ffmpeg.exec(['-i','input.mp4','-vn','-acodec','libmp3lame','-q:a','2','output_a.mp3']);
            await ffmpeg.exec(['-i','output_v.webm','-i','output_a.mp3','-c','copy','final.webm']);
            const fData = await ffmpeg.readFile('final.webm');
            await uploadToDrive(completeId, `Evolumate_${ts}_Merged.webm`, new Blob([fData.buffer], {type:'video/webm'}));
        } else {
            await uploadToDrive(completeId, `Evolumate_${ts}_Video.webm`, vBlob);
            setProgress(80, "處理音訊...");
            await ffmpeg.exec(['-i','input.mp4','-vn','-acodec','libmp3lame','-q:a','2','output_a.mp3']);
            const aData = await ffmpeg.readFile('output_a.mp3');
            await uploadToDrive(completeId, `Evolumate_${ts}_Audio.mp3`, new Blob([aData.buffer], {type:'audio/mp3'}));
        }

        setProgress(100, "完成！");
        alert("成功！檔案已上傳至 Drive。");

    } catch(e) {
        console.error(e);
        alert("錯誤: " + e.message);
    } finally {
        progressModal.classList.remove('active');
        try {
            await ffmpeg.deleteFile('input.mp4');
            await ffmpeg.deleteFile('output_v.webm');
            await ffmpeg.deleteFile('output_a.mp3');
            await ffmpeg.deleteFile('final.webm');
        } catch(e){}
    }
};

window.onload = initAuth;
</script>
</body>
</html>